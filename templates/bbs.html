<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>掲示板</title>
    <style>
        body { font-family: sans-serif; }
        .post {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        h1 small { color: #555; font-size: 0.5em; }
        .post-meta {
            margin-right: 10px;
        }
        .post-message {
            margin: 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>掲示板</h1>

    <form id="post-form">
        <p>名前: <input type="text" name="username" value="{{ saved_username }}" required></p>
        <p>シード値: <input type="password" name="seed" value="{{ saved_seed }}" required></p>
        <p><input type="checkbox" name="remember_me" {{ remember_me_checked }}> 名前とパスワードを保存する</p>
        <p>メッセージ: <br><textarea name="message" rows="5" cols="40" required></textarea></p>
        <p><input type="submit" value="投稿" id="submit-btn"></p>
    </form>

    <hr>
    <small><span id="current-topic">{{ current_topic }}</span></small>
    <h2>投稿一覧</h2>
    <div id="posts-list">
        {{ posts_list }}
    </div>

    <script>
        document.getElementById('post-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            setTimeout(() => { submitBtn.disabled = false; }, 5000);

            const form = event.target;
            const formData = new FormData(form);
            const data = {
                username: formData.get('username'),
                seed: formData.get('seed'),
                message: formData.get('message'),
                remember_me: formData.get('remember_me') === 'on'
            };

            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.posts) {
                    const postsList = document.getElementById('posts-list');
                    postsList.innerHTML = '';
                    let displayId = result.posts.length;
                    result.posts.forEach(post => {
                        const postElement = document.createElement('div');
                        postElement.className = 'post';
                        const utcTime = new Date(post.created_at);
                        const jstTime = new Date(utcTime.getTime() + 9 * 60 * 60 * 1000);
                        const formattedTime = jstTime.toISOString().slice(0, 19).replace('T', ' ');
                        
                        postElement.innerHTML = `
                            <span class="post-meta">No.${displayId} |</span>
                            <span class="post-meta">${post.username}@${post.user_id || ''} |</span>
                            <p class="post-message">${post.message.replace(/\n/g, '<br>')}</p>
                            <small>投稿日時: ${formattedTime}</small>
                        `;
                        postsList.appendChild(postElement);
                        displayId--;
                    });
                }
                if (result.topic) {
                    document.getElementById('current-topic').textContent = result.topic;
                }
                
                form.querySelector('[name="message"]').value = '';
                
                const seedInput = form.querySelector('[name="seed"]');
                const usernameInput = form.querySelector('[name="username"]');
                if (seedInput.value === data.seed) {
                    seedInput.value = data.seed;
                    usernameInput.value = data.username;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('投稿に失敗しました。');
            });
        });

        document.querySelector('textarea[name="message"]').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('post-form').dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>
